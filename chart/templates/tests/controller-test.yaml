{{- if .Values.verification.enableTests }}
apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "chart.name" . }}-controller-test"
  labels:
    {{- include "chart.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "1"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
  - name: controller-test
    image: bitnami/kubectl:latest
    command:
      - /bin/sh
      - -c
      - |
        echo "üîç Checking if controller pod is ready..."
        
        # Wait for deployment to be available
        kubectl wait --for=condition=available deployment/{{ include "chart.name" . }}-controller-manager \
          --namespace={{ .Release.Namespace }} \
          --timeout=300s
        
        if [ $? -eq 0 ]; then
          echo "‚úÖ Controller deployment is available!"
        else
          echo "‚ùå Controller deployment failed to become available"
          exit 1
        fi
        
        # Check if pod is actually running
        POD_STATUS=$(kubectl get pods -l control-plane=controller-manager \
          --namespace={{ .Release.Namespace }} \
          -o jsonpath='{.items[0].status.phase}' 2>/dev/null)
        
        if [ "$POD_STATUS" = "Running" ]; then
          echo "‚úÖ Controller pod is running successfully!"
          
          # Optional: Check if the pod is ready (all containers ready)
          POD_READY=$(kubectl get pods -l control-plane=controller-manager \
            --namespace={{ .Release.Namespace }} \
            -o jsonpath='{.items[0].status.conditions[?(@.type=="Ready")].status}' 2>/dev/null)
          
          if [ "$POD_READY" = "True" ]; then
            echo "‚úÖ Controller pod is ready and healthy!"
          else
            echo "‚ö†Ô∏è  Controller pod is running but not yet ready"
            exit 1
          fi
        else
          echo "‚ùå Controller pod status: $POD_STATUS"
          exit 1
        fi
        
        echo "üéâ All checks passed! Controller is running successfully!"
  serviceAccountName: {{ .Values.controller.serviceAccountName }}
{{- end }}
